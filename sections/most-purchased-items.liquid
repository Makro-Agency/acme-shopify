<div class="most-purchased-items-section container">
  <h2>{{ section.settings.title }}</h2>
  {% if customer and customer.orders.size > 0 %}
    {% assign latest_orders = customer.orders | sort: 'created_at' | reverse | slice: 0, 20 %}
    {% assign product_data = '' %}
    {% for order in latest_orders %}
      {% for item in order.line_items %}
        {% assign prod_id = item.product.id | append: '' %}
        {% assign found = false %}
        {% if product_data != '' %}
          {% assign product_data_array = product_data | split: '|||' %}
          {% for entry in product_data_array %}
            {% assign entry_parts = entry | split: ':::' %}
            {% if entry_parts[0] == prod_id %}
              {% assign found = true %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if found == false %}
          {% assign image_link = item.image | image_url:width:100 %}
          {% assign entry = prod_id | append: ':::' | append: item.title | append: ':::' | append: image_link | append: ':::' | append: '0' %}
          {% if product_data == '' %}
            {% assign product_data = entry %}
          {% else %}
            {% assign product_data = product_data | append: '|||' | append: entry %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endfor %}
    {% assign product_data_array = product_data | split: '|||' %}
    {% assign updated_product_data = '' %}
    {% for entry in product_data_array %}
      {% assign entry_parts = entry | split: ':::' %}
      {% assign prod_id = entry_parts[0] %}
      {% assign title = entry_parts[1] %}
      {% assign img = entry_parts[2] %}
      {% assign total_qty = 0 %}
      {% for order in latest_orders %}
        {% for item in order.line_items %}
            {% assign con_int = prod_id | plus: 0 %}
          {% if item.product.id == con_int %}
            {% assign total_qty = total_qty | plus: item.quantity %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {% assign new_entry = prod_id | append: ':::' | append: title | append: ':::' | append: img | append: ':::' | append: total_qty %}
      {% if updated_product_data == '' %}
        {% assign updated_product_data = new_entry %}
      {% else %}
        {% assign updated_product_data = updated_product_data | append: '|||' | append: new_entry %}
      {% endif %}
    {% endfor %}
    {% assign sorted_data = '' %}
    {% assign used_indexes = '' %}
    {% for i in (0..product_data_array.size) %}
      {% assign max_qty = -1 %}
      {% assign max_idx = -1 %}
      {% assign updated_array = updated_product_data | split: '|||' %}
      {% for j in (0..updated_array.size) %}
        {% if used_indexes contains j %}{% continue %}{% endif %}
        {% assign entry = updated_array[j] %}
        {% assign entry_parts = entry | split: ':::' %}
        {% assign qty = entry_parts[3] | plus: 0 %}
        {% if qty > max_qty %}
          {% assign max_qty = qty %}
          {% assign max_idx = j %}
        {% endif %}
      {% endfor %}
      {% if max_idx != -1 %}
        {% if sorted_data != '' %}{% assign sorted_data = sorted_data | append: '|||' %}{% endif %}
        {% assign sorted_data = sorted_data | append: updated_array[max_idx] %}
        {% assign used_indexes = used_indexes | append: ',' | append: max_idx %}
      {% endif %}
    {% endfor %}
    <div class="most-purchased-items-list">
      {% assign sorted_array = sorted_data | split: '|||' %}
      {% for entry in sorted_array %}
        {% assign entry_parts = entry | split: ':::' %}
        {% assign title = entry_parts[1] %}
        {% assign img = entry_parts[2] %}
        {% assign qty = entry_parts[3] %}
        {% if qty != '0' and title != blank %}
          <div class="most-purchased-item">
            {% if img != blank %}<img src="{{ img }}" alt="{{ title }}" width="100" height="100" />{% endif %}
            <div class="item-title">{{ title }}</div>
            <div class="item-qty">Purchased: {{ qty }}</div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% elsif customer %}
    <p>You have not placed any orders yet.</p>
  {% else %}
    <p>Please log in to see your most purchased items.</p>
  {% endif %}
</div>

{% schema %}
{
  "name": "Most Purchased Items",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Your Most Purchased Items"
    }
  ],
  "presets": [
    {
      "name": "Most Purchased Items"
    }
  ]
}
{% endschema %} 